{% extends 'base.html.twig' %}

{% block title %}Modifier Equipement{% endblock %}

{% block css %}
    {{ parent() }}
    <style>
        /* Contenu principal */
        .main-content {
            margin-left: 250px;
            flex: 1;
            position: relative;
            min-height: 100vh;
        }

        /* Formulaire */
        .centered-form {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .form-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .form-container h1 {
            font-size: 1.8rem;
            color: #2e384d;
            margin-bottom: 2rem;
            font-weight: 700;
            text-align: center;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .form-container h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: #4e73df;
            border-radius: 3px;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2e384d;
            font-size: 1rem;
            display: block;
        }
        
        .form-control-user, .form-select-user {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            border: 1px solid #d1d3e2;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .form-control-user:focus, .form-select-user:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
            outline: none;
        }
        
        textarea.form-control-user {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn-user {
            background-color: #4e73df;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 2rem auto 0;
            width: auto;
            min-width: 200px;
        }
        
        .btn-user:hover {
            background-color: #3a5ec0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Styles pour les erreurs */
        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .invalid-feedback {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: block;
        }
        
        /* Amélioration des inputs number */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Style pour le champ fichier */
        .custom-file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
        
        .custom-file-label {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            border: 1px solid #d1d3e2;
            border-radius: 6px;
            background-color: #f8f9fc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .custom-file-label:hover {
            background-color: #e2e6f0;
        }
        
        .custom-file-label::after {
            content: 'Parcourir';
            display: inline-block;
            margin-left: auto;
            padding: 0.5rem 1rem;
            background-color: #4e73df;
            color: white;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .file-name {
            margin-left: 0.5rem;
            color: #6c757d;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        
        .form-group.file-group {
            margin-bottom: 2rem;
        }
        
        /* Aperçu de l'image */
        .image-preview-container {
            margin-top: 1rem;
            text-align: center;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            border: 1px solid #d1d3e2;
            padding: 5px;
            background-color: #f8f9fc;
        }
        
        .image-preview-placeholder {
            color: #6c757d;
            font-style: italic;
            padding: 1rem;
            border: 1px dashed #d1d3e2;
            border-radius: 6px;
            background-color: #f8f9fc;
        }
        
        .current-image-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2e384d;
            font-size: 1rem;
            display: block;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="main-content">
        <div class="container centered-form">
            <div class="form-container">
                <div class="text-center">
                    <h1>Modifier Equipement</h1>
                </div>
                {% for message in app.flashes('error') %}
    <div class="alert alert-danger">{{ message }}</div>
{% endfor %}
                
                {{ form_start(form, {
    'attr': {
        'class': 'user', 
        'novalidate': 'novalidate',
        'method': 'POST',
        'enctype': 'multipart/form-data'
    }
}) }}
                
                    <!-- Champ Nom -->
                    <div class="form-group">
                        {{ form_label(form.nom, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.nom, {
                            'attr': {
                                'class': 'form-control form-control-user ' ~ (form.nom.vars.errors|length ? 'is-invalid' : ''),
                                'placeholder': 'Nom '
                            }
                        }) }}
                        <div class="invalid-feedback">
                            {{ form_errors(form.nom) }}
                        </div>
                    </div>
                    
                    <!-- Champ Description -->
                    <div class="form-group">
                        {{ form_label(form.description, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.description, {
                            'attr': {
                                'class': 'form-control form-control-user ' ~ (form.description.vars.errors|length ? 'is-invalid' : ''),
                                'rows': 4,
                                'placeholder': 'Description '
                            }
                        }) }}
                        <div class="invalid-feedback">
                            {{ form_errors(form.description) }}
                        </div>
                    </div>
                    
                    <!-- Champ Prix -->
                    <div class="form-group">
                        {{ form_label(form.prix, null, {'label_attr': {'class': 'form-label'}}) }}
                        <div class="input-group">
                            {{ form_widget(form.prix, {
                                'attr': {
                                    'class': 'form-control form-control-user ' ~ (form.prix.vars.errors|length ? 'is-invalid' : ''),
                                    'placeholder': 'Prix (DT)',
                                    'step': '0.01',
                                    'min': '0'
                                }
                            }) }}
                            <span class="input-group-text">DT</span>
                        </div>
                        <div class="invalid-feedback">
                            {{ form_errors(form.prix) }}
                        </div>
                    </div>
                    
                    <!-- Champ Quantité -->
                    <div class="form-group">
                        {{ form_label(form.quantiteStock, 'Quantité en stock', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.quantiteStock, {
                            'attr': {
                                'class': 'form-control form-control-user ' ~ (form.quantiteStock.vars.errors|length ? 'is-invalid' : ''),
                                'placeholder': 'Quantité disponible',
                                'min': '0'
                            }
                        }) }}
                        <div class="invalid-feedback">
                            {{ form_errors(form.quantiteStock) }}
                        </div>
                    </div>
                    
                    <!-- Champ Catégorie -->
                    <div class="form-group">
                        {{ form_label(form.categorie, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.categorie, {
                            'attr': {
                                'class': 'form-select-user ' ~ (form.categorie.vars.errors|length ? 'is-invalid' : '')
                            }
                        }) }}
                        <div class="invalid-feedback">
                            {{ form_errors(form.categorie) }}
                        </div>
                    </div>
                    
                    <!-- Champ Image -->
                    <div class="form-group file-group">
                        <label class="form-label">Image de l'équipement</label>
                        
                        <!-- Affichage de l'image actuelle -->
                        {% if equipement.image %}
                            <label class="current-image-label">Image actuelle :</label>
                            <div class="image-preview-container">
                                <img src="{{ asset('uploads/images/' ~ equipement.image) }}" alt="Image actuelle" class="image-preview" id="currentImage">
                            </div>
                            <input type="hidden" name="current_image" value="{{ equipement.image }}">
                        {% endif %}
                        
                        <!-- Champ de sélection de nouvelle image -->
                        <div class="custom-file mt-3">
                            {{ form_widget(form.imageFile, {
                                'attr': {
                                    'class': 'custom-file-input ' ~ (form.imageFile.vars.errors|length ? 'is-invalid' : ''),
                                    'accept': 'image/jpeg,image/png,image/gif'
                                }
                            }) }}
                            <label for="{{ form.imageFile.vars.id }}" class="custom-file-label">
                                <span class="file-name">{% if not equipement.image %}Choisir un fichier...{% else %}Changer l'image...{% endif %}</span>
                            </label>
                            <div class="invalid-feedback">
                                {{ form_errors(form.imageFile) }}
                            </div>
                        </div>
                        <small class="text-muted">Formats acceptés: JPEG, PNG, GIF (max 2Mo)</small>
                        
                        <!-- Aperçu de la nouvelle image -->
                        <div class="image-preview-container" id="imagePreviewContainer" style="{% if not equipement.image %}display: none;{% endif %}">
                            <div class="image-preview-placeholder" id="imagePlaceholder" style="{% if equipement.image %}display: none;{% endif %}">
                                Aperçu de la nouvelle image apparaîtra ici
                            </div>
                            <img src="" alt="Aperçu de la nouvelle image" class="image-preview" id="imagePreview" style="{% if equipement.image %}display: none;{% endif %}">
                        </div>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-user">
                            Modifier
                        </button>
                    </div>
                
                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <script>
       // Script pour afficher le nom du fichier sélectionné et l'aperçu
document.querySelector('.custom-file-input')?.addEventListener('change', function(e) {
    const fileInput = e.target;
    const fileName = fileInput.files[0] ? fileInput.files[0].name : '{% if not equipement.image %}Choisir un fichier...{% else %}Changer l\'image...{% endif %}';
    document.querySelector('.file-name').textContent = fileName;
    
    // Afficher l'aperçu de la nouvelle image
    const previewContainer = document.getElementById('imagePreviewContainer');
    const previewImage = document.getElementById('imagePreview');
    const placeholder = document.getElementById('imagePlaceholder');
    const currentImage = document.getElementById('currentImage');
    
    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            placeholder.style.display = 'none';
            previewImage.style.display = 'block';
            previewContainer.style.display = 'block';
            
            // Masquer l'image actuelle si on en sélectionne une nouvelle
            if (currentImage) {
                currentImage.style.display = 'none';
            }
        }
        
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        placeholder.style.display = 'block';
        previewImage.style.display = 'none';
        
        // Réafficher l'image actuelle si on annule la sélection
        if (currentImage) {
            currentImage.style.display = 'block';
        }
    }
});
    </script>
{% endblock %}